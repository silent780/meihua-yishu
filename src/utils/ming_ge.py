# -*- coding: utf-8 -*-
import itertools

# 天干地支定义
TIANGAN = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"]
DIZHI = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"]

# 五行属性：木、火、土、金、水
WUXING = {
    "甲": "木", "乙": "木", "丙": "火", "丁": "火", "戊": "土", "己": "土",
    "庚": "金", "辛": "金", "壬": "水", "癸": "水",
    "寅": "木", "卯": "木", "巳": "火", "午": "火", "辰": "土", "戌": "土", "丑": "土", "未": "土",
    "申": "金", "酉": "金", "亥": "水", "子": "水"
}

# 月令藏干（主气）
YUE_LING_ZANGGAN = {
    "寅": "甲", "卯": "乙", "辰": "戊", "巳": "丙", "午": "丁", "未": "己",
    "申": "庚", "酉": "辛", "戌": "戊", "亥": "壬", "子": "癸", "丑": "己"
}

# 十神关系（日干 → 其他天干）
SHISHEN = {
    "甲": {"甲": "比肩", "乙": "劫财", "丙": "食神", "丁": "伤官", "戊": "偏财", "己": "正财", 
           "庚": "七杀", "辛": "正官", "壬": "偏印", "癸": "正印"},
    "乙": {"甲": "劫财", "乙": "比肩", "丙": "伤官", "丁": "食神", "戊": "正财", "己": "偏财", 
           "庚": "正官", "辛": "七杀", "壬": "正印", "癸": "偏印"},
    "丙": {"甲": "偏印", "乙": "正印", "丙": "比肩", "丁": "劫财", "戊": "食神", "己": "伤官", 
           "庚": "偏财", "辛": "正财", "壬": "七杀", "癸": "正官"},
    "丁": {"甲": "正印", "乙": "偏印", "丙": "劫财", "丁": "比肩", "戊": "伤官", "己": "食神", 
           "庚": "正财", "辛": "偏财", "壬": "正官", "癸": "七杀"},
    "戊": {"甲": "七杀", "乙": "正官", "丙": "偏印", "丁": "正印", "戊": "比肩", "己": "劫财", 
           "庚": "食神", "辛": "伤官", "壬": "偏财", "癸": "正财"},
    "己": {"甲": "正官", "乙": "七杀", "丙": "正印", "丁": "偏印", "戊": "劫财", "己": "比肩", 
           "庚": "伤官", "辛": "食神", "壬": "正财", "癸": "偏财"},
    "庚": {"甲": "偏财", "乙": "正财", "丙": "七杀", "丁": "正官", "戊": "偏印", "己": "正印", 
           "庚": "比肩", "辛": "劫财", "壬": "食神", "癸": "伤官"},
    "辛": {"甲": "正财", "乙": "偏财", "丙": "正官", "丁": "七杀", "戊": "正印", "己": "偏印", 
           "庚": "劫财", "辛": "比肩", "壬": "伤官", "癸": "食神"},
    "壬": {"甲": "食神", "乙": "伤官", "丙": "偏财", "丁": "正财", "戊": "七杀", "己": "正官", 
           "庚": "偏印", "辛": "正印", "壬": "比肩", "癸": "劫财"},
    "癸": {"甲": "伤官", "乙": "食神", "丙": "正财", "丁": "偏财", "戊": "正官", "己": "七杀", 
           "庚": "正印", "辛": "偏印", "壬": "劫财", "癸": "比肩"}
}

def get_rigan(bazi):
    """获取日干（八字第4个字）"""
    return bazi[4]

def get_yuezhi(bazi):
    """获取月支（八字第3个字）"""
    return bazi[3]

def get_shishen(rigan, target_gan):
    """获取十神"""
    return SHISHEN.get(rigan, {}).get(target_gan, "未知")
def judge_geju(bazi):
    """
    判断八字格局（基于《渊海子平》的核心方法）
    
    :param bazi: 八字字符串（如 "辛卯 丁酉 庚午 丙子"）
    :return: 格局描述
    """
    rigan = get_rigan(bazi)  # 日干
    yuezhi = get_yuezhi(bazi)  # 月支
    yue_gan = YUE_LING_ZANGGAN.get(yuezhi, "")  # 月令藏干主气

    # 1. 判断日主强弱
    # （1）得令：月支（月令）是否生助日干
    de_ling = (WUXING.get(rigan) == WUXING.get(yuezhi))  # 日干与月令五行相同

    # （2）得地：地支是否有根
    def has_root(rigan, dizhi):
        """判断日干是否在地支有根"""
        roots = {
            "甲": ["寅", "卯", "辰"],
            "乙": ["寅", "卯", "辰"],
            "丙": ["巳", "午", "未"],
            "丁": ["巳", "午", "未"],
            "戊": ["辰", "戌", "丑", "未"],
            "己": ["辰", "戌", "丑", "未"],
            "庚": ["申", "酉", "戌"],
            "辛": ["申", "酉", "戌"],
            "壬": ["亥", "子", "丑"],
            "癸": ["亥", "子", "丑"]
        }
        return dizhi in roots.get(rigan, [])

    de_di = any(has_root(rigan, dz) for dz in bazi[1::2])  # 地支是否有根

    # （3）得势：天干是否有比劫
    de_shi = any(gan in ["甲", "乙"] if rigan in ["甲", "乙"] else
                 gan in ["丙", "丁"] if rigan in ["丙", "丁"] else
                 gan in ["戊", "己"] if rigan in ["戊", "己"] else
                 gan in ["庚", "辛"] if rigan in ["庚", "辛"] else
                 gan in ["壬", "癸"] for gan in bazi[::2])  # 天干比劫

    # 日主强弱综合判断
    rigan_strong = de_ling or de_di or de_shi

    # 2. 判断月令藏干
    # 月令藏干决定“格局提纲”
    tou_gan = False
    for gan in [bazi[0], bazi[2], bazi[6]]:  # 年干、月干、时干
        if gan == yue_gan:
            tou_gan = True
            break

    # 3. 定十神格局
    if tou_gan:
        shishen = get_shishen(rigan, yue_gan)
        if shishen in ["正官", "七杀"]:
            return f"{shishen}格（月令透干）"
        elif shishen in ["正财", "偏财"]:
            return f"{shishen}格"
        elif shishen == "伤官" and "印" in [get_shishen(rigan, gan) for gan in bazi[::2]]:
            return "伤官配印格"
    elif not rigan_strong:
        # 特殊格局判断
        if all(WUXING.get(dz) == "金" for dz in bazi[1::2]) and WUXING.get(rigan) == "木":
            return "从杀格（日主极弱，七杀旺）"
        elif all(WUXING.get(dz) == "火" for dz in bazi[1::2]) and WUXING.get(rigan) == "金":
            return "从财格（日主极弱，财星旺）"
        elif rigan == "甲" and "己" in bazi[::2]:
            return "化气格（甲己合化土）"

    # 4. 普通格局
    return "普通格局（需进一步分析）"


# 示例：输入八字（年柱、月柱、日柱、时柱）
bazi_sample = "辛卯 丁酉 庚午 丙子"  # 格式：年干年支 月干月支 日干日支 时干时支
bazi = bazi_sample.replace(" ", "")

print(f"八字：{bazi_sample}")
print(f"日干：{get_rigan(bazi)}")
print(f"月支：{get_yuezhi(bazi)}")
print(f"初步格局：{judge_geju(bazi)}")